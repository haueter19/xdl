<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Daniel Haueter">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <title>Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="{{ url_for('static', path='/style.css') }}" rel="stylesheet">
    <style>
        .admin-header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 1.25rem;
        }
        .admin-header a {
            font-size: 0.8rem;
            color: var(--color-muted);
            text-decoration: none;
        }
        .admin-header a:hover { color: var(--color-primary); }
        .admin-header .sep { color: var(--color-border); }
        .admin-header .page-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e293b;
        }
        .form-label-sm {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 3px;
        }
        .required-star { color: var(--color-negative); }
        .alert-flash {
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: var(--radius);
            margin-top: 8px;
        }
        /* Search results table */
        #resultsTable { font-size: 0.78rem; }
        #resultsTable tbody tr { cursor: pointer; }
        #resultsTable tbody tr:hover { background-color: var(--color-primary-light); }
        #resultsTable tbody tr.selected-row { background-color: #dbeafe; }

        /* Edit form grid */
        .edit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px 14px;
        }
        @media (max-width: 768px) {
            .edit-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .edit-field label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 2px;
            display: block;
        }
        .edit-field input {
            font-size: 0.8rem;
        }
        .edit-field.is-key input {
            background: #f8fafc;
            color: var(--color-muted);
        }
        #editSection { display: none; }
        #searchSection .spinner-border { width: 1rem; height: 1rem; border-width: .15em; }
    </style>
</head>
<body>
    <div class="admin-header">
        <a href="/">Home</a>
        <span class="sep">/</span>
        <span class="page-title">Admin</span>
    </div>

    <div class="container-fluid px-3">
        <div class="row g-3">

            <!-- ── Add Player ─────────────────────────────── -->
            <div class="col-lg-4">
                <div class="draft-card h-auto">
                    <div class="draft-card-header">Add Player</div>
                    <form id="addForm" novalidate>
                        <div class="mb-2">
                            <label class="form-label-sm">CBS ID <span class="required-star">*</span></label>
                            <input type="number" class="form-control form-control-sm" id="add_cbsid" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label-sm">CBS Name <span class="required-star">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="add_CBSNAME" required placeholder="Lastname, Firstname">
                        </div>
                        <div class="mb-2">
                            <label class="form-label-sm">Player Name</label>
                            <input type="text" class="form-control form-control-sm" id="add_PLAYERNAME" placeholder="Full name">
                        </div>
                        <div class="mb-2">
                            <label class="form-label-sm">FanGraphs ID</label>
                            <input type="text" class="form-control form-control-sm" id="add_IDFANGRAPHS">
                        </div>
                        <div class="mb-3">
                            <label class="form-label-sm">FanGraphs Minors ID</label>
                            <input type="text" class="form-control form-control-sm" id="add_IDFANGRAPHS_minors">
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Add Player</button>
                        <div id="addMsg"></div>
                    </form>
                </div>
            </div>

            <!-- ── Search & Edit ──────────────────────────── -->
            <div class="col-lg-8" id="searchSection">
                <div class="draft-card h-auto">
                    <div class="draft-card-header">Search Players</div>

                    <!-- Search controls -->
                    <div class="row g-2 mb-3">
                        <div class="col-sm-4">
                            <label class="form-label-sm">CBS ID</label>
                            <input type="number" class="form-control form-control-sm" id="search_cbsid" placeholder="e.g. 1234567">
                        </div>
                        <div class="col-sm-5">
                            <label class="form-label-sm">CBS Name (partial)</label>
                            <input type="text" class="form-control form-control-sm" id="search_name" placeholder="e.g. Smith">
                        </div>
                        <div class="col-sm-3 d-flex align-items-end gap-2">
                            <button class="btn btn-primary btn-sm flex-fill" id="searchBtn" onclick="searchPlayers()">Search</button>
                            <span id="searchSpinner" class="spinner-border text-primary d-none" role="status"></span>
                        </div>
                    </div>

                    <!-- Results table -->
                    <div id="resultsWrapper" style="display:none;">
                        <div class="table-responsive" style="max-height:260px; overflow-y:auto;">
                            <table class="table table-sm table-hover mb-0" id="resultsTable">
                                <thead class="sticky-top">
                                    <tr>
                                        <th>cbsid</th>
                                        <th>CBSNAME</th>
                                        <th>PLAYERNAME</th>
                                        <th>TEAM</th>
                                        <th>POS</th>
                                        <th>IDFANGRAPHS</th>
                                        <th>IDFANGRAPHS_minors</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody"></tbody>
                            </table>
                        </div>
                        <div id="resultsMeta" class="text-muted mt-1" style="font-size:0.72rem;"></div>
                    </div>

                    <div id="noResults" class="text-muted" style="font-size:0.82rem; display:none;">No players found.</div>
                    <div id="searchMsg"></div>
                </div>

                <!-- Edit record -->
                <div class="draft-card h-auto mt-3" id="editSection">
                    <div class="draft-card-header d-flex justify-content-between align-items-center">
                        <span>Edit Player — <span id="editTitle" class="text-primary"></span></span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="closeEdit()">✕ Close</button>
                    </div>
                    <form id="editForm" novalidate>
                        <input type="hidden" id="edit_cbsid_key">
                        <div class="edit-grid" id="editGrid"></div>
                        <div class="d-flex gap-2 mt-3">
                            <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="closeEdit()">Cancel</button>
                        </div>
                        <div id="editMsg" class="mt-2"></div>
                    </form>
                </div>
            </div>

        </div>
    </div>

<script>
// ── Column ordering for the edit form ────────────────────────────────────────
const COL_ORDER = [
    'cbsid', 'CBSNAME', 'PLAYERNAME', 'FIRSTNAME', 'LASTNAME',
    'BIRTHDATE', 'BATS', 'THROWS', 'ACTIVE', 'TEAM', 'LG', 'POS', 'ALLPOS',
    'IDFANGRAPHS', 'IDFANGRAPHS_minors', 'IDPLAYER', 'FANGRAPHSNAME',
    'MLBID', 'MLBNAME', 'ESPNID', 'ESPNNAME', 'YAHOOID', 'YAHOONAME',
    'BREFID', 'RETROID', 'NFBCID', 'NFBCNAME', 'BPID',
    'ROTOWIREID', 'FANTRAXID', 'FANTRAXNAME', 'ROTOWIRENAME',
    'MSTRBLLNAME', 'FANTPROSNAME', 'LASTCOMMAFIRST', 'NFBCLASTFIRST',
];

// ── Helpers ───────────────────────────────────────────────────────────────────
function flash(targetId, msg, type = 'success') {
    const el = document.getElementById(targetId);
    el.innerHTML = `<div class="alert alert-${type} alert-flash">${msg}</div>`;
    setTimeout(() => { el.innerHTML = ''; }, 4000);
}

// ── Add Player ────────────────────────────────────────────────────────────────
document.getElementById('addForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const cbsid = document.getElementById('add_cbsid').value.trim();
    const CBSNAME = document.getElementById('add_CBSNAME').value.trim();
    if (!cbsid || !CBSNAME) {
        flash('addMsg', 'CBS ID and CBS Name are required.', 'danger');
        return;
    }
    const body = {
        cbsid: parseInt(cbsid),
        CBSNAME,
        PLAYERNAME: document.getElementById('add_PLAYERNAME').value.trim() || null,
        IDFANGRAPHS: document.getElementById('add_IDFANGRAPHS').value.trim() || null,
        IDFANGRAPHS_minors: document.getElementById('add_IDFANGRAPHS_minors').value.trim() || null,
    };
    try {
        const res = await fetch('/admin/players', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.detail || 'Unknown error');
        flash('addMsg', `Player cbsid ${json.cbsid} added successfully.`, 'success');
        document.getElementById('addForm').reset();
    } catch (err) {
        flash('addMsg', err.message, 'danger');
    }
});

// ── Search Players ────────────────────────────────────────────────────────────
async function searchPlayers() {
    const cbsid = document.getElementById('search_cbsid').value.trim();
    const name  = document.getElementById('search_name').value.trim();
    if (!cbsid && !name) {
        flash('searchMsg', 'Enter a CBS ID or name to search.', 'warning');
        return;
    }
    const spinner = document.getElementById('searchSpinner');
    spinner.classList.remove('d-none');
    const params = new URLSearchParams();
    if (cbsid) params.append('cbsid', cbsid);
    if (name)  params.append('name', name);
    try {
        const res = await fetch(`/admin/players?${params}`);
        const players = await res.json();
        renderResults(players);
    } catch (err) {
        flash('searchMsg', 'Search failed: ' + err.message, 'danger');
    } finally {
        spinner.classList.add('d-none');
    }
}

// Allow Enter key in search fields
['search_cbsid', 'search_name'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
        if (e.key === 'Enter') searchPlayers();
    });
});

function renderResults(players) {
    const wrapper  = document.getElementById('resultsWrapper');
    const noRes    = document.getElementById('noResults');
    const tbody    = document.getElementById('resultsBody');
    const meta     = document.getElementById('resultsMeta');
    tbody.innerHTML = '';
    if (!players.length) {
        wrapper.style.display = 'none';
        noRes.style.display = 'block';
        return;
    }
    noRes.style.display = 'none';
    wrapper.style.display = 'block';
    meta.textContent = `${players.length} result${players.length > 1 ? 's' : ''}${players.length === 50 ? ' (limit 50)' : ''} — click a row to edit`;
    players.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = [
            p.cbsid, p.CBSNAME, p.PLAYERNAME, p.TEAM, p.POS, p.IDFANGRAPHS, p.IDFANGRAPHS_minors
        ].map(v => `<td>${v ?? ''}</td>`).join('');
        tr.addEventListener('click', () => {
            document.querySelectorAll('#resultsBody tr').forEach(r => r.classList.remove('selected-row'));
            tr.classList.add('selected-row');
            openEdit(p);
        });
        tbody.appendChild(tr);
    });
}

// ── Edit Player ───────────────────────────────────────────────────────────────
function openEdit(player) {
    document.getElementById('edit_cbsid_key').value = player.cbsid;
    document.getElementById('editTitle').textContent = `${player.CBSNAME} (cbsid ${player.cbsid})`;

    const grid = document.getElementById('editGrid');
    grid.innerHTML = '';

    // Render in COL_ORDER, then any remaining keys not in the list
    const allKeys = [...COL_ORDER, ...Object.keys(player).filter(k => !COL_ORDER.includes(k))];
    allKeys.forEach(col => {
        if (!(col in player)) return;
        const isKey = col === 'cbsid';
        const div = document.createElement('div');
        div.className = `edit-field${isKey ? ' is-key' : ''}`;
        div.innerHTML = `
            <label for="edit_${col}">${col}</label>
            <input type="text" class="form-control form-control-sm"
                   id="edit_${col}" name="${col}"
                   value="${player[col] ?? ''}"
                   ${isKey ? 'readonly' : ''}>
        `;
        grid.appendChild(div);
    });

    const section = document.getElementById('editSection');
    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    document.getElementById('editMsg').innerHTML = '';
}

function closeEdit() {
    document.getElementById('editSection').style.display = 'none';
    document.querySelectorAll('#resultsBody tr').forEach(r => r.classList.remove('selected-row'));
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const cbsid = document.getElementById('edit_cbsid_key').value;
    const inputs = document.querySelectorAll('#editGrid input:not([readonly])');
    const data = {};
    inputs.forEach(inp => { data[inp.name] = inp.value; });

    try {
        const res = await fetch(`/admin/players/${cbsid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data }),
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.detail || 'Unknown error');
        flash('editMsg', `Saved: ${json.updated.join(', ')}`, 'success');
    } catch (err) {
        flash('editMsg', err.message, 'danger');
    }
});
</script>
</body>
</html>
