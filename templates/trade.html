<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Daniel Haueter">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <title>Trade Analyzer</title>
    <style>
        .table { font-size: small; }
        .selected { background-color: rgb(144, 238, 144) !important; }
        .player-row { cursor: pointer; }
        .player-row:hover { background-color: #f0f0f0; }
        .player-row.selected:hover { background-color: rgb(120, 220, 120); }
        .totals-row { font-weight: bold; background-color: #e9ecef; }
        .bench-label { font-weight: bold; color: #6c757d; padding: 6px 0; }
        .delta-pos { color: green; font-weight: bold; }
        .delta-neg { color: red; font-weight: bold; }
        .delta-pos-inverse { color: red; font-weight: bold; }
        .delta-neg-inverse { color: green; font-weight: bold; }
        #tradeResults { display: none; }
        #simulateBtn { display: none; }
        .trade-summary { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-bottom: 10px; }
        .spinner-border-sm { width: 1rem; height: 1rem; border-width: .15em; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Team Selectors -->
        <div class="row m-2">
            <div class="col-6">
                <select id="team1Select" class="form-select form-select-sm">
                    <option value="" disabled selected>Select Team 1</option>
                    {% for row in teams %}
                    <option value="{{ row }}">{{ row }}</option>
                    {% endfor %}
                </select>
                <span id="team1Loading" style="display:none;">
                    <span class="spinner-border spinner-border-sm" role="status"></span> loading...
                </span>
            </div>
            <div class="col-6">
                <select id="team2Select" class="form-select form-select-sm">
                    <option value="" disabled selected>Select Team 2</option>
                    {% for row in teams %}
                    <option value="{{ row }}">{{ row }}</option>
                    {% endfor %}
                </select>
                <span id="team2Loading" style="display:none;">
                    <span class="spinner-border spinner-border-sm" role="status"></span> loading...
                </span>
            </div>
        </div>

        <!-- Trade Summary -->
        <div class="row m-2">
            <div class="col-6">
                <div class="trade-summary">
                    <strong id="team1GetsLabel">Team 2 sends:</strong>
                    <table class="table table-sm mb-0" id="team1Gets">
                        <thead><tr><th>z</th><th>HR</th><th>SB</th><th>R</th><th>RBI</th><th>BA</th><th>W</th><th>SO</th><th>Sv+Hld</th><th>ERA</th><th>WHIP</th></tr></thead>
                        <tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="col-6">
                <div class="trade-summary">
                    <strong id="team2GetsLabel">Team 1 sends:</strong>
                    <table class="table table-sm mb-0" id="team2Gets">
                        <thead><tr><th>z</th><th>HR</th><th>SB</th><th>R</th><th>RBI</th><th>BA</th><th>W</th><th>SO</th><th>Sv+Hld</th><th>ERA</th><th>WHIP</th></tr></thead>
                        <tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Simulate Button -->
        <div class="row m-2">
            <div class="col text-center">
                <button id="simulateBtn" class="btn btn-primary">
                    Simulate Trade
                </button>
                <button id="resetBtn" class="btn btn-outline-secondary ms-2" style="display:none;">
                    Reset
                </button>
            </div>
        </div>

        <!-- Rosters -->
        <div class="row m-2">
            <div class="col-6">
                <div id="team1Roster"></div>
            </div>
            <div class="col-6">
                <div id="team2Roster"></div>
            </div>
        </div>

        <!-- Trade Results -->
        <div id="tradeResults" class="row m-2">
            <div class="col-12">
                <h5>Trade Simulation Results</h5>
            </div>
            <div class="col-6">
                <h6 id="results1Label"></h6>
                <table class="table table-sm table-bordered" id="resultsTable1">
                    <thead>
                        <tr>
                            <th></th><th>z</th><th>HR</th><th>SB</th><th>R</th><th>RBI</th><th>BA</th>
                            <th>W</th><th>SO</th><th>Sv+Hld</th><th>ERA</th><th>WHIP</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="col-6">
                <h6 id="results2Label"></h6>
                <table class="table table-sm table-bordered" id="resultsTable2">
                    <thead>
                        <tr>
                            <th></th><th>z</th><th>HR</th><th>SB</th><th>R</th><th>RBI</th><th>BA</th>
                            <th>W</th><th>SO</th><th>Sv+Hld</th><th>ERA</th><th>WHIP</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Post-trade rosters -->
            <div class="col-6">
                <h6 id="postRoster1Label"></h6>
                <div id="postTeam1Roster"></div>
            </div>
            <div class="col-6">
                <h6 id="postRoster2Label"></h6>
                <div id="postTeam2Roster"></div>
            </div>
        </div>
    </div>

<script>
    var teamData = {};       // cached roster data keyed by team name
    var selectedTeam1 = null;
    var selectedTeam2 = null;
    var selected1 = new Set(); // cbsids selected from team 1
    var selected2 = new Set(); // cbsids selected from team 2

    // Fetch optimized roster for a team
    async function fetchTeamData(tm) {
        if (teamData[tm]) return teamData[tm];
        const resp = await fetch(`/optimize?tm=${encodeURIComponent(tm)}`);
        if (!resp.ok) throw new Error('Failed to fetch ' + tm);
        const data = await resp.json();
        teamData[tm] = data[tm];
        return data[tm];
    }

    // Build roster HTML from roster data. interactive=true enables click-to-select.
    function buildRosterHTML(roster, optTotals, interactive) {
        if (interactive === undefined) interactive = true;
        var rowClass = interactive ? 'player-row' : '';
        var h = '';
        var hitterHeaders = `<table class="table table-condensed table-hover table-sm">
            <thead><tr><th>Pos</th><th>Elig</th><th>Player</th><th>z</th><th>HR</th><th>SB</th><th>R</th><th>RBI</th><th>BA</th></tr></thead><tbody>`;
        var pitcherHeaders = `<table class="table table-condensed table-hover table-sm">
            <thead><tr><th>Pos</th><th>Elig</th><th>Player</th><th>z</th><th>W</th><th>SO</th><th>Sv+Hld</th><th>ERA</th><th>WHIP</th></tr></thead><tbody>`;
        var benchHitterStarted = false;
        var benchPitcherStarted = false;
        var startingHittersStarted = false;
        var startingPitchersStarted = false;

        roster.forEach(function(p) {
            if (p.opt_designation === 'starting_hitter') {
                if (!startingHittersStarted) {
                    h += '<div class="bench-label">Starting Hitters</div>' + hitterHeaders;
                    startingHittersStarted = true;
                }
                h += `<tr class="${rowClass}" data-cbsid="${p.cbsid}">
                    <td>${p.optimized_position}</td><td>${p.Pos}</td><td>${p.Player}</td>
                    <td>${p.z}</td><td>${p.HR}</td><td>${p.SB}</td><td>${p.R}</td><td>${p.RBI}</td><td>${p.BA}</td></tr>`;
            }
            if (p.opt_designation === 'starting_pitcher') {
                if (!startingPitchersStarted) {
                    h += `<tr class="totals-row"><td colspan="3">Hitter Totals</td>
                        <td>${optTotals.hitter_z}</td><td>${optTotals.HR}</td><td>${optTotals.SB}</td>
                        <td>${optTotals.R}</td><td>${optTotals.RBI}</td><td>${optTotals.BA}</td></tr>`;
                    h += '</tbody></table>';
                    h += '<div class="bench-label">Starting Pitchers</div>' + pitcherHeaders;
                    startingPitchersStarted = true;
                }
                h += `<tr class="${rowClass}" data-cbsid="${p.cbsid}">
                    <td>${p.optimized_position}</td><td>${p.Pos}</td><td>${p.Player}</td>
                    <td>${p.z}</td><td>${p.W}</td><td>${p.SO}</td><td>${p['Sv+Hld'] || 0}</td><td>${p.ERA}</td><td>${p.WHIP}</td></tr>`;
            }
            if (p.opt_designation === 'bench_hitter') {
                if (!benchHitterStarted) {
                    h += `<tr class="totals-row"><td colspan="3">Pitcher Totals</td>
                        <td>${optTotals.pitcher_z}</td><td>${optTotals.W}</td><td>${optTotals.SO}</td>
                        <td>${optTotals['Sv+Hld'] || 0}</td><td>${optTotals.ERA}</td><td>${optTotals.WHIP}</td></tr>`;
                    h += '</tbody></table>';
                    h += '<div class="bench-label">Bench Hitters</div>' + hitterHeaders;
                    benchHitterStarted = true;
                }
                h += `<tr class="${rowClass}" data-cbsid="${p.cbsid}">
                    <td>${p.optimized_position}</td><td>${p.Pos}</td><td>${p.Player}</td>
                    <td>${p.z}</td><td>${p.HR}</td><td>${p.SB}</td><td>${p.R}</td><td>${p.RBI}</td><td>${p.BA}</td></tr>`;
            }
            if (p.opt_designation === 'bench_pitcher') {
                if (!benchPitcherStarted) {
                    h += '</tbody></table>';
                    h += '<div class="bench-label">Bench Pitchers</div>' + pitcherHeaders;
                    benchPitcherStarted = true;
                }
                h += `<tr class="${rowClass}" data-cbsid="${p.cbsid}">
                    <td>${p.optimized_position}</td><td>${p.Pos}</td><td>${p.Player}</td>
                    <td>${p.z}</td><td>${p.W}</td><td>${p.SO}</td><td>${p['Sv+Hld'] || 0}</td><td>${p.ERA}</td><td>${p.WHIP}</td></tr>`;
            }
        });
        h += '</tbody></table>';
        return h;
    }

    // Update the trade summary table when a player is selected/deselected
    function updateSummaryTable(tableId, operation, playerData) {
        var tbl = $(`#${tableId} tbody tr`);
        var headers = $(`#${tableId} thead th`);
        var mult = operation === 'add' ? 1 : -1;
        tbl.find('td').each(function(index) {
            var stat = headers.eq(index).text();
            var mapped = stat;
            if (playerData[mapped] !== undefined) {
                var cur = Number($(this).text()) || 0;
                $(this).text((cur + mult * playerData[mapped]).toFixed(1));
            }
        });
    }

    // Show/hide simulate button based on selections
    function updateSimulateBtn() {
        if (selected1.size > 0 && selected2.size > 0) {
            $('#simulateBtn').show();
        } else {
            $('#simulateBtn').hide();
        }
    }

    // Render before/after results table
    function renderResultsTable(tableId, before, after) {
        var stats = ['z', 'HR', 'SB', 'R', 'RBI', 'BA', 'W', 'SO', 'Sv+Hld', 'ERA', 'WHIP'];
        // ERA and WHIP are inverse (lower is better)
        var inverseStats = ['ERA', 'WHIP'];
        var beforeRow = '<tr><td>Before</td>';
        var afterRow = '<tr><td>After</td>';
        var deltaRow = '<tr><td>Delta</td>';
        stats.forEach(function(s) {
            var b = before[s] || 0;
            var a = after[s] || 0;
            var d = a - b;
            var isInverse = inverseStats.includes(s);
            var cls = '';
            if (d > 0.001) cls = isInverse ? 'delta-pos-inverse' : 'delta-pos';
            else if (d < -0.001) cls = isInverse ? 'delta-neg-inverse' : 'delta-neg';
            var precision = ['BA', 'ERA', 'WHIP'].includes(s) ? 3 : 1;
            beforeRow += `<td>${b.toFixed(precision)}</td>`;
            afterRow += `<td>${a.toFixed(precision)}</td>`;
            deltaRow += `<td class="${cls}">${d >= 0 ? '+' : ''}${d.toFixed(precision)}</td>`;
        });
        beforeRow += '</tr>'; afterRow += '</tr>'; deltaRow += '</tr>';
        $(`#${tableId} tbody`).html(beforeRow + afterRow + deltaRow);
    }

    $(document).ready(function() {
        // Load team on select
        async function loadTeam(side, teamName) {
            var loadingId = side === 1 ? '#team1Loading' : '#team2Loading';
            var rosterId = side === 1 ? '#team1Roster' : '#team2Roster';
            $(loadingId).show();
            try {
                var data = await fetchTeamData(teamName);
                $(loadingId).hide();
                var html = buildRosterHTML(data.roster, data.opt_totals);
                $(rosterId).html(html);
            } catch (err) {
                $(loadingId).hide();
                $(rosterId).html('<div class="text-danger">Error loading roster</div>');
            }
        }

        $('#team1Select').change(function() {
            selectedTeam1 = $(this).val();
            selected1.clear();
            resetSummary('team1Gets');
            updateSimulateBtn();
            $('#tradeResults').hide();
            $('#team1GetsLabel').text(selectedTeam1 + ' gets:');
            $('#team2GetsLabel').text((selectedTeam2 || 'Team 2') + ' sends to ' + selectedTeam1 + ':');
            // Invalidate cache so re-optimization runs fresh
            delete teamData[selectedTeam1];
            loadTeam(1, selectedTeam1);
        });

        $('#team2Select').change(function() {
            selectedTeam2 = $(this).val();
            selected2.clear();
            resetSummary('team2Gets');
            updateSimulateBtn();
            $('#tradeResults').hide();
            $('#team2GetsLabel').text(selectedTeam2 + ' gets:');
            $('#team1GetsLabel').text((selectedTeam1 || 'Team 1') + ' sends to ' + selectedTeam2 + ':');
            delete teamData[selectedTeam2];
            loadTeam(2, selectedTeam2);
        });

        // Click to select/deselect players
        $(document).on('click', '.player-row', function() {
            var cbsid = Number($(this).data('cbsid'));
            var rosterId = $(this).closest('[id$="Roster"]').attr('id');
            var side = rosterId.includes('team1') ? 1 : 2;
            var selectedSet = side === 1 ? selected1 : selected2;
            var teamName = side === 1 ? selectedTeam1 : selectedTeam2;
            var summaryTable = side === 1 ? 'team2Gets' : 'team1Gets';

            var playerData = teamData[teamName].roster.find(p => p.cbsid === cbsid);
            if (!playerData) return;

            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
                selectedSet.delete(cbsid);
                updateSummaryTable(summaryTable, 'subtract', playerData);
            } else {
                $(this).addClass('selected');
                selectedSet.add(cbsid);
                updateSummaryTable(summaryTable, 'add', playerData);
            }
            updateSimulateBtn();
        });

        // Simulate trade
        $('#simulateBtn').click(async function() {
            if (!selectedTeam1 || !selectedTeam2 || selected1.size === 0 || selected2.size === 0) return;

            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Simulating...');
            try {
                var resp = await fetch('/simulate_trade', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        team1: selectedTeam1,
                        team2: selectedTeam2,
                        team1_players: Array.from(selected1),
                        team2_players: Array.from(selected2)
                    })
                });
                var result = await resp.json();

                // Show results
                $('#results1Label').text(selectedTeam1);
                $('#results2Label').text(selectedTeam2);
                renderResultsTable('resultsTable1', result.team1.before, result.team1.after);
                renderResultsTable('resultsTable2', result.team2.before, result.team2.after);

                // Build post-trade rosters
                $('#postRoster1Label').text(selectedTeam1 + ' - Post-Trade Optimized Roster');
                $('#postRoster2Label').text(selectedTeam2 + ' - Post-Trade Optimized Roster');

                // Calculate post-trade opt_totals from the after data for display
                var postTotals1 = result.team1.after;
                var postTotals2 = result.team2.after;
                $('#postTeam1Roster').html(buildRosterHTML(result.team1.roster, postTotals1, false));
                $('#postTeam2Roster').html(buildRosterHTML(result.team2.roster, postTotals2, false));

                $('#tradeResults').show();
                $('#resetBtn').show();
            } catch (err) {
                alert('Error simulating trade: ' + err.message);
            }
            $(this).prop('disabled', false).text('Simulate Trade');
        });

        // Reset
        $('#resetBtn').click(function() {
            selected1.clear();
            selected2.clear();
            $('.player-row').removeClass('selected');
            resetSummary('team1Gets');
            resetSummary('team2Gets');
            $('#tradeResults').hide();
            $('#resetBtn').hide();
            updateSimulateBtn();
        });
    });

    function resetSummary(tableId) {
        $(`#${tableId} tbody td`).text('0');
    }
</script>
</body>
</html>
